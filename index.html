<html ng-app="myApp">
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.8/angular.min.js"></script>
		<script src="angular-ui-router.js"></script>
		<link rel="stylesheet" href="styles.css">
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	</head>
	<body>
		<div ui-view="main"></div>
		<script>
			var myApp = angular.module('myApp', ['ui.router']);
			
			myApp.config(function ($stateProvider, $urlRouterProvider, $locationProvider) {

				$locationProvider.html5Mode(true);

				$urlRouterProvider.otherwise('/items?category=beer');

				$stateProvider
				.state('main', {
					abstract: true,
					views: {
						'main': {
							templateUrl: 'main.html',
							controller: 'MainCtrl'
						}
					}
				})
				.state('main.items', {
					url: '/items?category',
					views: {
						'content': {
							templateUrl: 'items.html',
							controller: 'ItemsCtrl'
						}
					},
					resolve: {
						items: function (itemFactory) {
							return itemFactory.getItems();
						}
					}
				})
				.state('main.cart', {
					url: '/cart',
					views: {
						'content': {
							templateUrl: 'cart.html',
							controller: 'CartCtrl'
						}
					}
				});

			});

			myApp.controller('MainCtrl', function ($scope, cartFactory, $timeout) {
				$scope.cart = cartFactory.cart;
				$scope.costOfCart = cartFactory.costOfCart;
				$scope.cartStyle = {};
				$scope.$on('itemAdded',function (event) {
					$scope.cartStyle = {
						color: "red"
					};
					$timeout(function () {
						$scope.cartStyle = {};
					},360);
				})
			})

			myApp.controller('ItemsCtrl', function ($scope, cartFactory, itemFactory, items, $stateParams) {
				$scope.header = $stateParams.category || 'all';
				$scope.formItem = {
					category: $stateParams.category
				};
				$scope.items = items;


				$scope.formSubmitted = function () {
					if ($scope.formItem._id) {
						itemFactory.updateItem($scope.formItem);
					} else {
						itemFactory.createItem($scope.formItem).then(function () {
							$scope.notification = 'New item successfully added!';
							$scope.formItem = {
								category: $stateParams.category
							};
						});
					}
				}

				$scope.deleteItem = function (id) {
					itemFactory.deleteItem(id);
				}

				$scope.editItem = function (item) {
					$scope.formItem = item;
				}

				$scope.itemInCategory = function (item) {
					return (!$stateParams.category || (item.category == $stateParams.category));
				}

				$scope.addToCart = function (item) {
					console.log('hello');
					cartFactory.addToCart(item);
					$scope.$emit('itemAdded');
				}

				$scope.cheapItem = $scope.items.filter($scope.itemInCategory).sort(function (a,b) {
					return a.price > b.price;
				})[0];
			});

			myApp.factory('itemFactory', function ($http, $q) {
				var returnObject = {};
				var items = [];

				returnObject.deleteItem = function (id) {
					$http({
						method: 'DELETE',
						url: '/api/items/' + id
					}).then(function(data) {
						for (var i=0; i< items.length;i++) {
							if (items[i]._id == id) items.splice(i,1);
						}
						alert('Item deleted!');
					})
				}

				returnObject.updateItem = function (item) {
					$http({
						method: 'PUT',
						url: '/api/items/' + item._id,
						data: {
							item: item
						}
					}).then(function (data) {
						item = data.data;
						// for (var i=0;i<items.length;i++) {
						// 	if (items[i]._id == data.data._id)	items[i] = data.data;
						// }
					})
				}

				returnObject.createItem = function (item) {
					var promise = $http({
						method: 'POST',
						url: '/api/items',
						data: {
							item: item
						}
					});

					promise.then(function (data) {
						items.push(data.data);
					});

					return promise;
				}

				returnObject.getItems = function () {

					if (items.length) return items;

					var defer = $q.defer();

					$http({
						method:'GET',
						url: '/api/items'
					}).then(function (data) { //success
						console.log(data);

						items = data.data;
						defer.resolve(data.data);
					}, function () { //error
						defer.reject();
					});

					return defer.promise;
				}

				return returnObject;
			})

			myApp.filter('titleCase', function() {
				return function(str) {
					return (str == undefined || str === null) ? '' : str.replace(/_|-/, ' ').replace(/\w\S*/g, function(txt){
						return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
		    		});
		    	}
		    });

			myApp.factory('cartFactory', function() {

				var cart = {};

				cart.cart = [];

				cart.addToCart = function (item) {
					cart.cart.push(item);
				}

				cart.removeFromCart = function (index) {
					cart.cart.splice(index,1);
				}

				cart.costOfCart = function () {
					return cart.cart.reduceRight(function (a, b) {return a + b.price;},0);
				}

				return cart;

			});

			myApp.controller('CartCtrl', function ($scope,cartFactory) {
				$scope.header = 'Cart';

				$scope.removeFromCart = cartFactory.removeFromCart;
			});

			myApp.directive('item', function () {
				return {
					scope: {
						item: "=info",
						special: "@",
						addToCart: "&"
					},
					restrict: 'E',
					templateUrl: 'item.html'
				}
			})

		</script>
	</body>
</html>